var IMHWPB=IMHWPB||{};IMHWPB.Editor=function(e){var t=this;this.media_default_bound=!1;var i=e(window);this.row_selector_string="",this.content_selector_string="",this.column_selector_string="",this.currently_selected_size=null,this.crop=new BoldgridEditor.crop(e),this.select_alignment=function(){var i=e(tinymce.activeEditor.selection.getNode()),n=e(".attachments-browser select.alignment"),a=e(".attachments-browser select.link-to");if(0==t.media_default_bound&&(t.media_default_bound=!0,wp.media.frame.on("open",t.select_alignment)),i.is("img")){var r=i.attr("class"),s=[];r&&(s=i.attr("class").split(/\s+/));var l="none";e.each(s,function(e,t){return"aligncenter"==t?(l="center",!1):"alignnone"==t?(l="none",!1):"alignright"==t?(l="right",!1):"alignleft"==t?(l="left",!1):void 0});var o=null,c=i.parent("a");c.length||(o="none"),a.length&&o&&a.val(o).change(),n.length&&n.val(l).change()}},this.select_default_alignment=function(){e(document).on("click",".attachments-browser .attachment",t.select_alignment)},this.draggable=function(){var e=null;return IMHWPB.WP_MCE_Draggable&&IMHWPB.WP_MCE_Draggable.instance&&(e=IMHWPB.WP_MCE_Draggable.instance.draggable_instance),e},this.override_insert_media=function(){var t=send_to_editor;send_to_editor=function(i){var n=[];if(!i.match(/^\[.+?\]/))var a=e(tinymce.activeEditor.selection.getContent()),r=e(i),s=r.is("img")||r.is("a")&&r.find("*").is("img");if(s&&a.is("img")&&r.find("img").length<=1){var l=[],o=a.attr("class"),c=[];o&&(c=o.split(/\s+/));var g=a.attr("width"),d=a.attr("height");e.each(c,function(e,t){t.match(/size-/)||t.match(/align/)||t.match(/wp-image-/)||l.push(t)});var _=null;if(r.is("img"))var _=r;else var _=r.find("img");e.each(l,function(e,t){_.addClass(t)}),_.attr("height",d).attr("width",g);var m=e(tinymce.activeEditor.selection.getNode()),h=m.parent();if(h.length&&"A"==h[0].tagName&&(m=h),m.replaceWith(r[0].outerHTML),tinymce.activeEditor.fire("setContent"),tinymce.activeEditor.focus(),tinymce.activeEditor.execCommand("mceAddUndoLevel"),window.tb_remove)try{window.tb_remove()}catch(b){}}else n.push(i),t.apply(this,n)}},e(function(){t.select_default_alignment(),t.original_column_val=e('[name="screen_columns"]:checked').val(),tinymce.PluginManager.add("monitor_view_imhwpb",function(i,n){i.addButton("monitor_view_imhwpb",{title:"Desktop View",icon:"icon dashicons dashicons-desktop imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-desktop",onclick:function(i){t.activate_display("monitor",e(i.target))}})}),tinymce.PluginManager.add("tablet_view_imhwpb",function(i,n){i.addButton("tablet_view_imhwpb",{title:"Tablet View",icon:"icon dashicons dashicons-tablet imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-tablet",onclick:function(i){t.activate_display("tablet",e(i.target))}})}),tinymce.PluginManager.add("phone_view_imhwpb",function(i,n){i.addButton("phone_view_imhwpb",{title:"Phone View",icon:"icon dashicons dashicons-smartphone imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-phone",onclick:function(i){t.activate_display("phone",e(i.target))}})}),tinymce.PluginManager.add("toggle_draggable_imhwpb",function(i,n){t.override_insert_media(),i.addButton("toggle_draggable_imhwpb",{title:"BoldGrid Editing",icon:"icon genericon genericon-move",classes:"widget btn",onclick:t.toggle_draggable_plugin}),i.on("BeforeAddUndo",function(t){if(IMHWPBGallery&&IMHWPBGallery.init_gallery&&IMHWPBGallery.init_gallery(e(i.iframeElement).contents()),1==IMHWPB.tinymce_undo_disabled)return!1}),i.on("SetContent",function(i){t.reset_anchor_spaces(tinymce.activeEditor.getBody(),!0),e.fourpan&&e.fourpan.refresh&&e.fourpan.refresh(),"html"==i.format&&t.dragging_is_active()&&(i.set||IMHWPB.WP_MCE_Draggable.instance.draggable_instance.validate_markup(),IMHWPB.WP_MCE_Draggable&&IMHWPB.WP_MCE_Draggable.instance&&IMHWPB.WP_MCE_Draggable.instance.refresh_iframe_height&&setTimeout(function(){IMHWPB.WP_MCE_Draggable.instance.refresh_iframe_height()},500))}),i.on("KeyDown",function(n){var a,r;if(!t.draggable)return!0;var s=e(tinymce.activeEditor.selection.getNode());t.dragging_is_active()&&IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container.trigger("is-typing-keydown");var l=s.is(t.draggable.column_selectors_string),o=s.is(t.draggable.row_selectors_string),c=s.is("A");if(l||o){if(n.which>=48&&n.which<=90||n.which>=96&&n.which<=105||13==n.which){if(0==s.is(":empty")&&0!==s.find("> br").siblings().length)return;if(13==n.which)return a=e('<div class="row"><div class="col-md-12"></div></div>'),s.closest(".row").after(a),i.selection.setCursorLocation(a.find(".col-md-12")[0],0),!1;l?(r=e("<p><br></p>"),a=r):(a=e('<div class="col-md-12"><p><br></p></div>'),r=a.find("p")),s.html(a),i.selection.setCursorLocation(r[0],0)}}else if(c&&!("8"!=n.which&&"46"!=n.which||"&nbsp;&nbsp;"!=s.html()&&"&nbsp; "!=s.html()))return s.remove(),!1;return!0}),i.on("NodeChange",function(t){var n=e(t.element);if("A"==t.element.tagName){var a=tinymce.DOM.createRng(),r=tinymce.activeEditor.selection.getRng(),s=null;if(r.startOffset==r.endOffset)if(0===r.startOffset)("&nbsp;"==t.element.firstChild.data.substr(0,6)||/\s/.test(t.element.firstChild.data.substr(0,1)))&&(s=1);else if(t.element.firstChild&&r.startOffset==t.element.firstChild.length){var l=0;("&nbsp;"==t.element.firstChild.data.substr(-6)||/\s/.test(t.element.firstChild.data.substr(-1)))&&(l=-1),s=t.element.firstChild.length+l}s&&(a.setStart(t.element.firstChild,s),a.setEnd(t.element.firstChild,s),tinymce.activeEditor.selection.setRng(a))}t.selectionChange&&n.length&&n.is("br")&&n.parent().children().each(function(){var t=e(this);if(t.is("a")&&t.html()&&!t.find("img").length)return $new_element=t.find(":first"),$new_element.length||($new_element=t),i.selection.setCursorLocation($new_element[0],1),!1})}),i.on("SetAttrib",function(e){if(e.attrElm.hasClass("wpview-wrap")&&"undefined"!=typeof IMHWPB.WP_MCE_Draggable.instance){var t=IMHWPB.WP_MCE_Draggable.instance.draggable_instance;t.resize&&t.$master_container.trigger("mouseup",e.attrElm)}}),i.on("mousedown",function(i){if(t.draggable){var n,a=e(i.target),r=!0===tinymce.activeEditor.boldgridResize,s=a.closest(".draggable-tools-imhwpb").length,l=!t.draggable.ie_version&&a.hasClass("action-list")&&!a.attr("draggable"),o=s&&!l;(o||r)&&(i.button=!0,i.preventDefault=function(){},n=e("<div><div></div></div>"),n[0].contentEditable=!1,i.target=n[0])}}),i.on("dragstart",function(t){var i=e(t.originalTarget);i.hasClass("popover-imhwpb")&&t.preventDefault()}),i.on("ObjectResizeStart",function(e){"undefined"!=typeof IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container&&(IMHWPB.WP_MCE_Draggable.instance.draggable_instance.popovers_disabled=!0,IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container.find(".draggable-tools-imhwpb").addClass("hidden"))}),i.on("ObjectResized",function(e){"undefined"!=typeof IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container&&(IMHWPB.WP_MCE_Draggable.instance.draggable_instance.popovers_disabled=!1,IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container.find(".draggable-tools-imhwpb").removeClass("hidden"))}),i.on("GetContent",function(e){if(e.content&&(e.content=t.reset_anchor_spaces("<div>"+e.content+"</div>",!1),IMHWPB.WP_MCE_Draggable.instance&&IMHWPB.WP_MCE_Draggable.instance.draggable_instance&&(e.content=IMHWPB.WP_MCE_Draggable.instance.draggable_instance.frame_cleanup(e.content)),e.save)){var i=jQuery("<div>"+e.content+"</div>"),n=i.find("> *:last");if(n.is("p")){var a=n.text(),r=n.html();(" "==a||"<br>"==r&&!a||"&nbsp;"==r)&&(n.remove(),e.content=i.html())}}}),i.on("init",function(i){IMHWPB.WP_MCE_Draggable.instance=new IMHWPB.WP_MCE_Draggable,setTimeout(function(){IMHWPB.WP_MCE_Draggable.instance.refresh_iframe_height()},1e3),setTimeout(function(){IMHWPB.WP_MCE_Draggable.instance.refresh_iframe_height()},3e3);var n=e(i.target.iframeElement).contents();BoldgridEditor.body_class&&n.find("body").addClass(BoldgridEditor.body_class),BoldgridEditor.hasDraggableEnabled?(IMHWPB.WP_MCE_Draggable.instance.load_draggable(n),t.draggable=IMHWPB.WP_MCE_Draggable.instance.draggable_instance,t.draggable.ie_version&&t.draggable.ie_version<=11&&n.find("body").addClass("dragging-disabled")):(IMHWPB.WP_MCE_Draggable.instance.set_style_sheet_inactive("draggable",!0,e(i.target.iframeElement).contents().get(0)),IMHWPB.WP_MCE_Draggable.instance.draggable_inactive=!0),t.button_created=!1,tinymce.activeEditor.on("wptoolbar",function(e){if(0==t.button_created&&e.toolbar){var i=[];i.push(tinymce.ui.Factory.create({type:"button",title:"Change",tooltip:"Change",icon:"icon dashicons dashicons-admin-media imhwpb-icon",onclick:function(){tinymce.activeEditor.buttons.wp_img_edit.onclick(),wp.media.frame.setState("replace-image"),wp.media.frame.state("replace-image").on("replace",function(e){t.crop.onReplace(e)})}})),e.toolbar._items[0]._items[0].insert(i,3,!1),e.toolbar.reposition(),t.button_created=!0}})})})}),this.mce_element_is_empty=function(e){var t=e.children(),i=!1;return(e.is(":empty")||1==t.length&&t.filter("br").length&&!e.text())&&(i=!0),i},this.reset_anchor_spaces=function(t,i){var n=e(t);return n.find("a").each(function(){var t=e(this),n=t.html();"&nbsp;"==n.substr(0,6)&&(n=n.substr(6)),"&nbsp;"==n.substr(-6,6)&&(n=n.substr(0,n.length-6)),i?t.html("&nbsp;"+n+"&nbsp;"):t.html(n)}),n.html()},this.dragging_is_active=function(){return"undefined"!=typeof IMHWPB.WP_MCE_Draggable.instance&&0==IMHWPB.WP_MCE_Draggable.instance.draggable_inactive},this.toggle_draggable_plugin=function(e){"undefined"!=typeof IMHWPB.WP_MCE_Draggable&&"undefined"!=typeof IMHWPB.WP_MCE_Draggable.instance&&IMHWPB.WP_MCE_Draggable.instance.toggle_draggable_plugin(e)},this.activate_display=function(n,a){var r=a.closest("div");return!r.hasClass("mce-disabled")&&(e(".mce-displaysize-imhwpb").removeClass("boldgrid-highlighted-mce-icon"),r.hasClass("mce-active")?(a.closest("div").removeClass("mce-active"),t.remove_editor_styles(),t.currently_selected_size=null):(e(".mce-displaysize-imhwpb").each(function(){e(this).closest("div").removeClass("mce-active")}),a.closest("div").addClass("mce-active"),t.set_width(n),t.currently_selected_size=n),void(IMHWPB.WP_MCE_Draggable.instance&&0==IMHWPB.WP_MCE_Draggable.instance.draggable_inactive&&(IMHWPB.WP_MCE_Draggable.instance.resize_done_event(null,!0),i.trigger("resize"))))},this.remove_editor_styles=function(){e("#wp-content-editor-container").removeClass("mce-viewsize-phone-imhwpb mce-viewsize-tablet-imhwpb mce-viewsize-monitor-imhwpb")},this.set_width=function(i){t.remove_editor_styles(),e("#wp-content-editor-container").addClass("mce-viewsize-"+i+"-imhwpb")}},IMHWPB.Editor.instance=new IMHWPB.Editor(jQuery);