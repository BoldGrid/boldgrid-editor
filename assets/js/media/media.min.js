var IMHWPB=IMHWPB||{};IMHWPB.Media=function(e){var t=this;this.search_params="",this.location="",e(function(){t.on_page_load(),e("#insert-gridblocks-button").on("click",function(){wp.media.editor.open(),wp.media.frame.setState("iframe:insert_layout")})}),this.on_page_load=function(){"undefined"!=typeof IMHWPB.Globals&&IMHWPB.Globals.isIframe&&t.iframe_onload()},this.build_tabs=function(t){var i="";return e.each(t,function(e,t){t.content[0]&&(i+='<a class="media-menu-item" data-tabname="'+e+'" href="#">'+t.name+"</a>")}),i},this.handle_iframe_load=function(i){var a=e("#__wp-uploader-id-0"),n=e(".media-router"),r=e(".media-toolbar-primary"),s=e(".media-selection");a.removeClass("hide-toolbar"),a.removeClass("hide-router"),n.html(t.build_tabs(i)),r.html('<a href="#" class="button media-button button-primary button-primary-disabled button-large">Insert into page</a>'),s.addClass("empty"),t.setup_top_tab_nav(),t.register_tab_click_events(),t.insert_to_page_event()},this.setup_top_tab_nav=function(){e(".media-menu-item").on("click",function(){e(this).parent().find(".media-menu-item").removeClass("active"),e(this).addClass("active")})},this.register_tab_click_events=function(){e(".media-router .media-menu-item").on("click",function(){e(".media-iframe iframe")[0].contentWindow.IMHWPB.Media.instance.enable_iframe_content(e(this).data("tabname"))}),e(".media-router .media-menu-item:first").click()},this.insert_to_page_event=function(){e(".media-toolbar .media-button").on("click",function(t){if(t.preventDefault(),0==e(this).hasClass("button-primary-disabled")){var i=e(".media-iframe iframe")[0].contentWindow.IMHWPB.Media.instance,a=function(t){i.uncheck_all(),e(".media-modal-close").click();var a=t.match(/^\[.+\]$/),n=null;if(0!=a&&null!=a||(n=e(t)),n&&IMHWPB.WP_MCE_Draggable.draggable_instance&&n.is(IMHWPB.WP_MCE_Draggable.draggable_instance.row_selectors_string)){var r=tinymce.activeEditor.selection.getNode(),s=e(r).closest_context(IMHWPB.WP_MCE_Draggable.draggable_instance.row_selectors_string,IMHWPB.WP_MCE_Draggable.draggable_instance.$master_container);s.length?s.before(n):e(tinyMCE.activeEditor.getBody()).prepend(n),IMHWPB.WP_MCE_Draggable.draggable_instance.validate_markup(),tinymce.activeEditor.fire("setContent"),tinymce.activeEditor.focus()}else send_to_editor(t);e(window).trigger("resize")},n=i.find_selected_elements();"string"!=typeof n?n.always(a):a(n)}})},this.toggle_insert_button=function(t){var i=e(".media-toolbar").find(".button");t===!0?i.removeClass("button-primary-disabled"):t===!1&&i.addClass("button-primary-disabled")},this.find_current_location=function(){"object"==typeof navigator&&"object"==typeof navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){t.location={center:[e.coords.latitude,e.coords.longitude].join(",")}})},this.iframe_onload=function(){var e=null;switch(IMHWPB.Globals["tab-details"].type){case"api":e=t.find_api_content,t.bind_search_form(),t.find_current_location();break;case"html":e=t.insert_image;break;case"shortcode-form":e=t.insert_markup,t.bind_checkbox_selections()}parent.IMHWPB.Media.instance.handle_iframe_load(IMHWPB.Globals.tabs),t.disable_insert_button(),t.prevent_attachment_content_actions(),t.register_sidebar_event_handlers(),t.register_attachment_click_events(e,IMHWPB.Globals["tab-details"]["selection-type"]),"shortcode-form"==IMHWPB.Globals["tab-details"].type&&t.preselect_form(),t.translate_image_urls()},this.prevent_attachment_content_actions=function(){e(".centered-content-boldgrid").on("click","button, a",function(){return!1})},this.preselect_form=function(){parent.jQuery(parent).on("boldgrid_edit_form",function(e,i){t.select_form_action(i)}),"undefined"!=typeof parent.IMHWPB.editform&&parent.IMHWPB.editform&&t.select_form_action(parent.IMHWPB.editform)},this.select_form_action=function(i){var a=i.shortcode.attrs.named,n=e(".media-sidebar-boldgrid");t.deselect_all_attachments();var r=n.find("#title-toggle-boldgrid"),s=n.find("#description-enable-boldgrid"),d=n.find("#ajax-enable-boldgrid");t.preselect_checkbox(r,a.title),t.preselect_checkbox(s,a.description),t.preselect_checkbox(d,a.ajax);var o=n.find("#tabindex-wrapper-boldgrid");a.tabindex?(o.find("input").val(a.tabindex),o.removeClass("hidden")):(o.find("input").val(""),o.addClass("hidden")),e('[data-form-id-boldgrid="'+a.id+'"]').find(".attachment-preview").click()},this.preselect_checkbox=function(e,t){e.length&&("true"==t?(e.val(!0),e.prop("checked",!0)):(e.val(!1),e.prop("checked",!1)))},this.bind_checkbox_selections=function(){var i=e(".media-sidebar-boldgrid");i.on("submit","form",function(){return!1}),i.find("#title-toggle-boldgrid").on("click",function(){t.set_sidebar_title_visibility()}),i.find("#description-enable-boldgrid").on("click",function(){t.set_sidebar_description_visibility()})},this.set_sidebar_title_visibility=function(){var t=e(".media-sidebar-boldgrid").find(".gform_title");e("#title-toggle-boldgrid").prop("checked")?t.show():t.hide()},this.set_sidebar_description_visibility=function(){var t=e(".media-sidebar-boldgrid").find(".gform_description");e("#description-enable-boldgrid").prop("checked")?t.show():t.hide()},this.register_sidebar_event_handlers=function(){e('.media-sidebar-boldgrid a[title="advanced-options"]').on("click",function(t){t.preventDefault(),e("#tabindex-wrapper-boldgrid").toggleClass("hidden")})},this.disable_insert_button=function(){e(".media-sidebar img").on("load",function(){e(this).attr("src")?parent.IMHWPB.Media.instance.toggle_insert_button(!0):parent.IMHWPB.Media.instance.toggle_insert_button(!1)})},this.perform_search=function(){t.search_params={center:e('input[name="map-search-imhwpb"]').val()},t.find_api_content(e(".attachment.selected"))},this.bind_search_form=function(){e("#search-map-imhwpb").on("submit",function(e){e.preventDefault(),t.perform_search()}),e(".media-sidebar .searchbutton").on("click",function(){t.perform_search()}),e('#search-map-imhwpb select[name="select-size-imhwpb"]').on("change",function(){"custom"==e(this).val()?e("#map-dimensions-imhwpb").removeClass("hidden"):e("#map-dimensions-imhwpb").addClass("hidden")})},this.enable_iframe_content=function(t){e(".attachments").addClass("hidden"),e('.attachments[data-tabname="'+t+'"]').removeClass("hidden")},this.translate_image_urls=function(){var t=e('[data-tabname="basic-gridblocks"] [data-boldgrid-asset-id]');t.each(function(){var t=e(this),i=t.data("boldgrid-asset-id");if(IMHWPB.configs&&IMHWPB.configs.api_key){var a=IMHWPB.configs.asset_server+IMHWPB.configs.ajax_calls.get_asset+"?key="+IMHWPB.configs.api_key+"&id="+i;t.attr("src",a),t.attr("data-pending-boldgrid-attribution",1)}else IMHWPB.Media.GridBlocks.swap_image_with_placeholder(t)})},this.find_selected_elements=function(){var i="";switch(IMHWPB.Globals["tab-details"].type){case"html":i=IMHWPB.Media.GridBlocks.get_selected_html();break;case"api":e.param(t.search_params.center);i='<a href="http://maps.google.com/?q='+t.search_params.center+'"><img src="'+e(".media-sidebar").find("img").attr("src")+'"></a>';break;case"shortcode-form":var a=e('.attachment[aria-checked="true"]').data("form-id-boldgrid");i=t.create_form_shortcode(a)}return i},this.create_form_shortcode=function(t){var i=e(".media-sidebar-boldgrid"),a=i.find("#title-toggle-boldgrid").prop("checked"),n=i.find("#description-enable-boldgrid").prop("checked"),r=i.find("#ajax-enable-boldgrid").prop("checked"),s=i.find("#tabindex-wrapper-boldgrid input").val();return a=a?' title="true"':' title="false"',n=n?' description="true"':' description="false"',r=r?' ajax="true"':"",s=""!=s?' tabindex="'+s+'"':"",'[ninja_forms id="'+t+'"]'},this.uncheck_all=function(){e('.attachment[aria-checked="true"]').each(function(){e(this).attr("aria-checked",!1),e(this).removeClass("details selected"),e(".media-sidebar > div").addClass("hidden")})},this.find_selected_map_size=function(){var t=e(".media-sidebar"),i=t.find('select[name="select-size-imhwpb"]'),a=i.find("option:selected"),n=a.data("width"),r=a.data("height");return"custom"==i.val()&&(n=t.find('input[name="custom-width-imhwpb"]').val(),r=t.find('input[name="custom-height-imhwpb"]').val()),{size:n+"x"+r}},this.find_api_content=function(i){var a=i.closest(".attachments").data("tabname"),n=IMHWPB.Globals.tabs[a].content[i.data("id")]["map-params"];t.search_params.center&&IMHWPB.Globals["tab-details"]["default-location-setting"]!=t.search_params||(t.location?t.search_params=t.location:t.search_params=IMHWPB.Globals["tab-details"]["default-location-setting"]);var r=IMHWPB.Globals["tab-details"]["base-url"]+"?"+e.param(e.extend(t.search_params,n,t.find_selected_map_size()));t.image_replacement(r)},this.insert_image=function(i){if("raw"!=i.data("html-type")){var a=i.find("img").attr("src");t.image_replacement(a)}else{t.image_replacement("");var n=e(".media-sidebar"),r=i.find(".centered-content-boldgrid").html();n.find(".centered-content-boldgrid").html("<div>"+r+"</div>"),n.find(".fullwidth-imhwpb").addClass("hidden"),n.find("> div").removeClass("hidden");var s=n.find(".centered-content-boldgrid > div")[0].getBoundingClientRect().height;e(".boldgrid-markup-container").css({height:parseInt(s)+15+"px"}),parent.IMHWPB.Media.instance.toggle_insert_button(!0)}},this.insert_markup=function(i){var a=e(".media-sidebar"),n=i.find(".centered").html();e(".boldgrid-markup-container").html(n),a.find("> div").removeClass("hidden");var r=a.find(".gform_wrapper")[0].getBoundingClientRect().height;e(".boldgrid-markup-container").css({height:parseInt(r)+15+"px"});var s=i.data("form-id-boldgrid");t.insert_edit_link(s),t.set_sidebar_title_visibility(),t.set_sidebar_description_visibility(),parent.IMHWPB.Media.instance.toggle_insert_button(!0)},this.insert_edit_link=function(t){var i=IMHWPB.Globals["admin-url"]+"admin.php?page=gf_edit_forms&id="+t;e(".media-sidebar").find(".editform-link a:first").attr("href",i)},this.image_replacement=function(t){var i=e(".media-sidebar");i.find(".centered-content-boldgrid").empty(),i.find("img.fullwidth-imhwpb").attr("src",t).removeClass("hidden"),i.find("> div").removeClass("hidden")},this.deselect_attachment=function(e){1==e.hasClass("selected")&&(e.removeClass("selected"),e.attr("aria-checked",!1),e.removeClass("details"))},this.deselect_all_attachments=function(){e(".attachment").each(function(){t.deselect_attachment(e(this))})},this.register_attachment_click_events=function(i,a){e(document).on("click",".attachment",function(){var n=e(this).closest(".attachment");"single-item"==a&&t.deselect_all_attachments(),e(".attachment").removeClass("details"),n.addClass("details"),0==n.hasClass("selected")&&(n.addClass("selected"),n.attr("aria-checked",!0)),i(n)}),e(document).on("click",'.check[title="Deselect"]',function(i){i.stopPropagation();var a=e(this).closest(".attachment");t.deselect_attachment(a),e(".media-sidebar > div").addClass("hidden"),0==e(".attachment.selected").length&&parent.IMHWPB.Media.instance.toggle_insert_button(!1)})}},IMHWPB.Media.instance=new IMHWPB.Media(jQuery);